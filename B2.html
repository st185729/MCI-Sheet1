<html>
<head>
    <title>Human Capabilities - Reaction test</title>
    <style>
        body {
            font-family: sans-serif;
            display: block;
            position: absolute;
            z-index: 1;
            left: 0;
            top: 0;
            width:100%;
            height:100%;
            background-color: white;
        }
        canvas {
            background-color: transparent;
            display: block;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
<h1 id="title">User Study</h1>
<h2 id="instruction">Press space to start!</h2>
<div id="stimulus"></div>
<p id="time"></p>
<p id="count"></p>
<p id="mean"></p>
<p id="sd"></p>
<p id="errors"></p>

<canvas id="myCanvas"></canvas>



<script>

    // if true, the experiment is currently active
    let experimentActive = false;

    // if true, the stimulus is currently visible and the user should press space
    let stimulusIsVisible = false;

    // time at which the stimulus last appeared (in milliseconds, see Date.now())
    let stimulusTimestamp;

    // ID of the timeout that is scheduled to make the stimulus appear.
    // Used to cancel tests when the experiment ends.
    let testStimulusTimeout;

    // recorded reaction times in milliseconds
    let times = [];



    // DOM elements
    let timeElement = document.getElementById('time');
    let countElement = document.getElementById('count');
    let meanElement = document.getElementById('mean');
    let stdDevElement = document.getElementById('sd');
    let instructionElement = document.getElementById('instruction');
    let ctx = document.getElementById('myCanvas').getContext('2d');
    let errorsElement = document.getElementById('errors');
    let trialsCounter = 0;
    let errors = 0;
    let stimulusx = 0;
    let stimulusy = 0;
    let squareWidth = 0;
    let triangleWidth = 0;
    let stimulusShape = 0;

    ctx.canvas.width  = document.documentElement.clientWidth;
    ctx.canvas.height = document.documentElement.clientHeight;

    function getMean(data) {
        let sum = 0;
        for (let value of data) sum += value;
        return sum / data.length;
    }

    function getStandardDeviation(data) {
        let mean = getMean(data);
        let squareSum = 0;
        for (let value of data) squareSum += (value - mean) ** 2;
        return Math.sqrt(squareSum / data.length);
    }

    function clearResults() {
        timeElement.textContent = '';
        countElement.textContent = '';
        meanElement.textContent = '';
        stdDevElement.textContent = '';
    }

    function showResults() {
        let meanDeltaTime = getMean(times);
        let stdDev = getStandardDeviation(times);

        countElement.textContent = 'Count: ' + times.length;
        meanElement.textContent = 'Mean: ' + Math.round(meanDeltaTime) + ' ms';
        stdDevElement.textContent = 'SD: ' + Math.round(stdDev) + ' ms';
        errorsElement.textContent = 'Errors:' + errors;
    }

    function setStimulusColor(newColor) {
        ctx.fillStyle = newColor;
    }

    function startTestTrial() {
        if(trialsCounter < 31){
            trialsCounter++;
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            stimulusIsVisible = false;
            isSquare = false;

            // schedule the stimulus to appear after a random amount of time
            let timeToWaitInSeconds = Math.random() * 4 + 2; // 2 - 6s
            testStimulusTimeout = setTimeout(showStimulus, timeToWaitInSeconds * 1000);
            //showStimulus();
            return;
        }
        stopExperiment();
    }
    function drawRectangle(x, y){

        squareWidth = 100 + (Math.random() * ((200) + 1));
        //squareWidth = Math.random()*300;
        ctx.fillRect(x, y, squareWidth, squareWidth);
        stimulusShape = "square";
    }

    function drawTriangle(x, y){
        stimulusShape = "triangle";

        triangleWidth = 100 + (Math.random() * ((200) + 1));
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x+triangleWidth, y);
        ctx.lineTo(x+triangleWidth/2, y+triangleWidth);
        ctx.closePath();
        ctx.fill();
        setTimeout(startTestTrial, 6000);
    }

    function showStimulus() {
        stimulusx = Math.floor((Math.random() * ctx.canvas.width));
        stimulusy = Math.floor((Math.random() * ctx.canvas.height));

        colorDecider = Math.random()*10
        if(colorDecider < 5){
            setStimulusColor('purple')
        } else {
            setStimulusColor('orange')
        }

        let shapeDecider = Math.random()*10

        if(shapeDecider < 5){
            drawRectangle(stimulusx, stimulusy)
        } else {
            drawTriangle(stimulusx, stimulusy)
        }
        stimulusIsVisible = true;
        stimulusTimestamp = Date.now();
    }

    function recordStimulusReactionTime() {
        let deltaTime = Date.now() - stimulusTimestamp;
        times.push(deltaTime);
        timeElement.textContent = deltaTime + ' ms';
    }

    function startExperiment() {
        clearResults(); // clear results of any previous tests
        instructionElement.textContent = "Press space when you see a square! You can skip triangles by pressing 's'";

        // reset data and start tests
        times = [];
        experimentActive = true;
        trialsCounter++;
        startTestTrial();
    }

    function stopExperiment() {
        // cancel any ongoing tests
        clearTimeout(testStimulusTimeout);
        stimulusIsVisible = false;
        experimentActive = false;

        // reset instruction and show results
        instruction.textContent = 'Press space to start!';
        showResults();
    }

    window.addEventListener('keydown', (event) => {
        if (event.key === ' ') {
            // the user pressed the space key
            if (!experimentActive) {
                // start the experiment if it wasn't active
                startExperiment()
                return;
            }
            if (stimulusIsVisible && stimulusShape === "square") {
                // record reaction time
                recordStimulusReactionTime();
                // start next trial
                startTestTrial();
            } else if(stimulusIsVisible && stimulusShape ==="triangle"){
                errors++;

            }
        } else if (event.key === 'a') {
            if (experimentActive ) {
                // stop the experiment and show results
                stopExperiment();
            }
        }  else if (event.key === 's' && stimulusShape==="triangle") {
            startTestTrial();
        }
    });
</script>
</body>
</html>
